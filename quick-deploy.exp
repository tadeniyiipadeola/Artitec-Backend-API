#!/usr/bin/expect -f
# Quick deployment script using expect (no sshpass required)

set timeout 600

puts "ğŸš€ Starting Artitec Backend deployment update...\n"

spawn ssh Admin@100.94.199.71
expect "password:" { send "Password1\r" }
expect "$ "

puts "ğŸ“‚ Navigating to deployment directory..."
send "cd /volume1/docker/Artitec-Backend-API\r"
expect "$ "

puts "ğŸ“¥ Pulling latest changes from GitHub..."
send "sudo git pull origin main\r"
expect {
    "password" {
        send "Password1\r"
        exp_continue
    }
    "Already up to date" {
        puts "\nâœ… Code is already up to date!"
    }
    "Updating" {
        puts "\nğŸ“ New changes detected, updating..."
        exp_continue
    }
    "$ " {}
}

puts "\nğŸ›‘ Stopping current container..."
send "sudo docker stop artitec-api 2>/dev/null || true\r"
expect {
    "password" { send "Password1\r"; exp_continue }
    "$ " {}
}

send "sudo docker rm artitec-api 2>/dev/null || true\r"
expect {
    "password" { send "Password1\r"; exp_continue }
    "$ " {}
}

puts "\nğŸ³ Building new Docker image (this takes 2-5 minutes)..."
send "sudo docker build -t artitec-backend:latest .\r"
expect {
    "password" {
        send "Password1\r"
        exp_continue
    }
    -timeout 600 "Successfully tagged" {
        puts "\nâœ… Docker image built successfully!"
        exp_continue
    }
    -timeout 600 "$ " {}
}

puts "\nğŸš€ Starting new container..."
send "sudo docker run -d --name artitec-api --network host --env-file .env --restart unless-stopped -v \\$(pwd)/uploads:/app/uploads artitec-backend:latest\r"
expect {
    "password" { send "Password1\r"; exp_continue }
    "$ " {}
}

puts "\nâ³ Waiting 5 seconds for container to start..."
send "sleep 5\r"
expect "$ "

puts "\nâœ… Container status:"
send "sudo docker ps | grep artitec\r"
expect {
    "password" { send "Password1\r"; exp_continue }
    "$ " {}
}

puts "\nğŸ“‹ Recent logs:"
send "sudo docker logs --tail 20 artitec-api\r"
expect {
    "password" { send "Password1\r"; exp_continue }
    "$ " {}
}

send "exit\r"
expect eof

puts "\n\nâœ… Deployment update complete!"
puts "API running at: http://100.94.199.71:8000"
puts "API Docs: http://100.94.199.71:8000/docs"
